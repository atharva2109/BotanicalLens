<!DOCTYPE html>
<html lang="en">

<!-- Head Section -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Details</title>
    <link rel="stylesheet" href="./stylesheets/plantdetails/style.css">
    <script src='/javascripts/API.js'></script>
    <script>
        API();
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <%- include('./partials/base'); %>
</head>

<!-- Body Section -->
<body>

<!-- Header Section -->
<%- include('./partials/header', { title: 'Plant Details',visibility:'hidden' }); %>
<br> <br> <br>
<div class="row">
    <div class="col-md-4 order-md-2 mb-4">

        <!-- User Details Sections -->
        <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">User Details</span>
            <span class="badge badge-secondary badge-pill">3</span>
        </h4>
        <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between bg-light">
                <div class="text-success">
                    <h6 class="my-0">Username :</h6>
                </div>
                <span class="text-success"><%= sighting.username %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Email ID</h6>
                </div>
                <span class="text-muted"> <%= sighting.email %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Contact Number</h6>
                </div>
                <span class="text-muted"><%= sighting.phoneNumber %></span>
            </li>
        </ul>

        <!-- Sighting Details Section -->
        <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Sighting Details</span>
            <span class="badge badge-secondary badge-pill">3</span>
        </h4>
        <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div id="map" style="height: 300px; width: 600px;">

                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Elevation</h6>
                </div>
                <span class="text-muted"><%= sighting.altitude %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Address</h6>
                </div>
                <span class="text-muted"> <%= sighting.line %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">City/Town</h6>
                </div>
                <span class="text-muted"><%= sighting.city %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">State</h6>
                </div>
                <span class="text-muted"> <%= sighting.state %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Postal Code</h6>
                </div>
                <span class="text-muted"><%= sighting.pinCode %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Country</h6>
                </div>
                <span class="text-muted"> <%= sighting.country %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Date of Sighting</h6>
                </div>
                <span class="text-muted"> <%= sighting.date %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Number of Observations</h6>
                </div>
                <span class="text-muted"><%=          %></span>
            </li>
        </ul>
    </div>
    <div class="col-md-8 order-md-1">
        <h4 class="mb-3">Plant Details</h4>
        <hr>
        <h1 style="font-size:xxx-large; color: #36454F"><%= sighting.name %></h1>
        <h5 class="link-dark" style="font-size: small">
            Reference link: <a href="<%= sighting.identificationLink %>"
                               class="text-primary"><%= sighting.identificationLink %></a>
        </h5>
        <br>
        <div class="image-container">
                <img src="http://localhost:3000/<%= sighting.uploadImage %>" alt="Plant Image"
                     style="object-fit: cover;" loading="lazy">
        </div>
        <br><br>
        <ul class="list-group mb-3">
            <li class="list-group-item justify-content-between bg-light">
                <div class="text-success">
                    <h6 class="my-0">Plant Name : <span class="text-success"><%= sighting.name %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Common Name : <span class="text-muted"><%= sighting.commonName %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Scientific Name : <span
                                class="text-muted"><%= sighting.scientificName %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Family : <span class="text-muted"><%= sighting.family %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Genus : <span class="text-muted"><%= sighting.genus %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Species : <span class="text-muted"><%= sighting.species %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Description : <span class="text-muted"><%= sighting.description %></span>
                    </h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Plant Size : (Length: <%= sighting.length %> x Height: <%= sighting.height %> x Width: <%= sighting.width %>)</h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Characteristics:</h6><br>
                    <div class="d-flex flex-wrap gap-2">
                        <h4><span class="badge bg-primary"><%= sighting.flowering ? 'Flowering' : 'Non-Flowering' %></span></h4>
                        <h4><span class="badge bg-secondary"><%= sighting.hasLeaves ? 'Has Leaves' : 'Has No Leaves' %></span></h4>
                        <h4><span class="badge bg-success"><%= sighting.fruitBearing ? 'Fruit Bearing' : 'Non-Fruit Bearing' %></span></h4>
                        <h4><span class="badge bg-danger"><%= sighting.sunExposure %></span></h4>
                        <h4><span class="badge bg-warning text-dark">Color: <%= sighting.flowerColor %></span></h4>
                    </div>
                </div>
            </li>
        </ul>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#chatModal">
            Chat about <%= sighting.plant.name %>
        </button>

        <!-- Chat Modal -->
        <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="chatModalLabel">Chat about <%= sighting.plant.name %></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="messageDisplay" style="height: 300px; overflow-y: scroll;"></div>
                        <form id="messageForm">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="username" placeholder="Enter your username" required>
                            </div>
                            <div class="mb-3">
                                <textarea class="form-control" id="message" rows="3" placeholder="Type your message here..." required></textarea>
                            </div>
                            <button type="button" onclick="sendMessage()" class="btn btn-primary">Send</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include('./partials/footer'); %>

<script>
    console.log("Socket.io script loaded");
    var socket = io();
    socket.on('connect', () => {
        console.log('Connected to server');
    });
    console.log("Socket initialized", socket);

    document.addEventListener("DOMContentLoaded", function() {
        console.log("DOMContentLoaded");
        var myModal = new bootstrap.Modal(document.getElementById('chatModal'));
        document.getElementById('chatModalTrigger').addEventListener('click', function() {
            console.log("DOMContentLoaded");
            myModal.show();
        });
    });

    function sendMessage() {
        console.log("sendMessage called");
        const message = {
            username: $('#username').val(),
            message: $('#message').val(),
            plantName: '<%= sighting.plant.name %>',
            plantId: '<%= sighting._id %>'
        };
        console.log("Sending message:", message);
        socket.emit('chatMessage', message);
        $('#message').val('');
    }

    $(document).ready(function() {
        console.log("jQuery ready");
        const plantName = '<%= sighting.plant.name %>';

        socket.on('connect', () => {
            console.log("Socket connected, joining room", plantName);
            socket.emit('joinRoom', plantName);
        });

        socket.on('message', message => {
            console.log("Message received", message);
            $('#messageDisplay').append(`<div><strong>${message.username}</strong>: ${message.message}</div>`);
        });

        $('#messageForm').submit(function(e) {
            e.preventDefault();
            console.log("Form submitted");
            sendMessage();
        });

        $('#sendButton').on('click', function() {
            console.log("Send button clicked");
            sendMessage();
        });
    });


</script>
<script src="/public/javascripts/bootstrap.min.js"></script>

<script>
    function initMap() {

        // Holds the value for the location
        var location = '<%= sighting.location %>';
        const [latitude, longitude] = location.split(',');

        // Convert the latitude and longitude to float values
        const lat = parseFloat(latitude.trim());
        const long = parseFloat(longitude.trim());

        createMapWithMarker(lat, long, "map");
    }

    function createMapWithMarker(latitude, longitude, mapElementId) {
        let mapOptions = {
            zoom: 5,
            center: {lat: latitude, lng: longitude}
        };
        let map = new google.maps.Map(document.getElementById(mapElementId), mapOptions);

        let markerOptions = {
            position: new google.maps.LatLng(latitude, longitude),
            map: map
        };
        let marker = new google.maps.Marker(markerOptions);
    }
</script>
</body>
</html>
