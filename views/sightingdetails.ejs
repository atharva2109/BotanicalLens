<!DOCTYPE html>
<html lang="en">

<!-- Head Section -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Details</title>
    <link rel="stylesheet" href="./stylesheets/plantdetails/style.css">
    <script src='/javascripts/API.js'></script>
    <script src='/javascripts/sightings.js'></script>
    <script>
        API();
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <%- include('./partials/base'); %>
</head>

<!-- Body Section -->
<body>

<!-- Header Section -->
<%- include('./partials/header', { title: 'Plant Details',visibility:'hidden' }); %>
<br>
<br>
<br>
<div class="row">
    <div class="col-md-4 order-md-2 mb-4">

        <!-- User Details Sections -->
        <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">User Details</span>
            <span class="badge badge-secondary badge-pill">3</span>
        </h4>
        <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between bg-light">
                <div class="text-success">
                    <h6 class="my-0">Username :</h6>
                </div>
                <span class="text-success"><%= sighting.username %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Email ID</h6>
                </div>
                <span class="text-muted"> <%= sighting.email %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Contact Number</h6>
                </div>
                <span class="text-muted"><%= sighting.phoneNumber %></span>
            </li>
        </ul>

        <!-- Sighting Details Section -->
        <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Sighting Details</span>
            <span class="badge badge-secondary badge-pill">3</span>
        </h4>
        <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div id="map" style="height: 300px; width: 600px;">

                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Elevation</h6>
                </div>
                <span class="text-muted"><%= sighting.altitude %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Address</h6>
                </div>
                <span class="text-muted"> <%= sighting.line %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">City/Town</h6>
                </div>
                <span class="text-muted"><%= sighting.city %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">State</h6>
                </div>
                <span class="text-muted"> <%= sighting.state %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Postal Code</h6>
                </div>
                <span class="text-muted"><%= sighting.pinCode %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Country</h6>
                </div>
                <span class="text-muted"> <%= sighting.country %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Date of Sighting</h6>
                </div>
                <span class="text-muted"> <%= sighting.date %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Number of Observations</h6>
                </div>
                <span class="text-muted"><%=                %></span>
            </li>
        </ul>
    </div>
    <div class="col-md-8 order-md-1">
        <h4 class="mb-3">Plant Details</h4>
        <hr>
        <div class="d-flex">
            <h1 style="font-size:xxx-large; color: #36454F"><%= sighting.name %></h1>
            <div class="verification-icon"></div>
        </div>
        <br>
        <div class="image-container" style="max-width: 100%; height: 500px;">
            <img src="<%= sighting.uploadImage %>" alt="Plant Image"
                 style="width: 100%; height: 100%; object-fit: contain;">
        </div>
        <br><br>
        <ul class="list-group mb-3">

            <li class="list-group-item justify-content-between bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-success edit-mode d-none">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="d-flex align-items-center">
                                <h6 class="my-0 me-2">Plant Name:</h6>
                                <textarea class="form-control" rows="1" style="flex-grow: 1;" data-field="name"><%= sighting.name %></textarea>
                            </div>
                            <div class="">
                                <!-- Save button with image -->
                                <a class="text-success edit-save-btn" title="Save">
                                    <img src="/images/icons/tickmark.png" alt="Save" width="30" height="30">
                                </a>
                                <!-- Cancel button with image -->
                                <a class="text-danger edit-cancel-btn" title="Cancel">
                                    <img src="/images/icons/cancel.png" alt="Cancel" width="30" height="30">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="text-success edit-mode-display">
                        <h6 class="my-0">Plant Name: <span class="text-success"><%= sighting.name %></span></h6>
                    </div>
                    <div class="edit-button-container">
                        <a class="text-primary edit-button">
                            <img src="/images/icons/pencil-edit.png" alt="Edit" width="20" height="20">
                        </a>
                    </div>
                </div>
            </li>

            <li class="list-group-item justify-content-between">
                <div class="d-flex justify-content-between align-items-center">
                    <!-- Edit mode container (initially hidden) -->
                    <div class=" edit-mode d-none">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="d-flex align-items-center">
                                <!-- Label -->
                                <h6 class="my-0 me-2">Common Name:</h6>
                                <!-- Textarea for editing the value -->
                                <textarea class="form-control" rows="2" style="flex-grow: 1;" data-field="common-name"><%= sighting.commonName %></textarea>
                            </div>
                            <!-- Container for save and cancel buttons -->
                            <div class="">
                                <!-- Save button -->
                                <a class="text-success edit-save-btn" title="Save">
                                    <img src="/images/icons/tickmark.png" alt="Save" width="30" height="30">
                                </a>
                                <!-- Cancel button -->
                                <a class="text-danger edit-cancel-btn" title="Cancel">
                                    <img src="/images/icons/cancel.png" alt="Cancel" width="30" height="30">
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- Display mode container -->
                    <div class=" edit-mode-display">
                        <h6 class="my-0">Common Name: <span class="text-muted"><%= sighting.commonName %></span></h6>
                    </div>
                    <!-- Edit button -->
                    <div class="edit-button-container">
                        <a class="text-primary edit-button">
                            <img src="/images/icons/pencil-edit.png" alt="Edit" width="18" height="18">
                        </a>
                    </div>
                </div>
            </li>

            <li class="list-group-item justify-content-between">
                <div class="d-flex justify-content-between align-items-center">
                    <!-- Edit mode container (initially hidden) -->
                    <div class=" edit-mode d-none">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="d-flex align-items-center">
                                <!-- Label -->
                                <h6 class="my-0 me-2">Scientific Name:</h6>
                                <!-- Textarea for editing the value -->
                                <textarea class="form-control" rows="3" style="flex-grow: 1;" data-field="scientific-name"><%= sighting.scientificName %></textarea>
                            </div>
                            <!-- Container for save and cancel buttons -->
                            <div class="">
                                <!-- Save button -->
                                <a class=" edit-save-btn" title="Save">
                                    <img src="/images/icons/tickmark.png" alt="Save" width="30" height="30">
                                </a>
                                <!-- Cancel button -->
                                <a class="text-danger edit-cancel-btn" title="Cancel">
                                    <img src="/images/icons/cancel.png" alt="Cancel" width="30" height="30">
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- Display mode container -->
                    <div class=" edit-mode-display">
                        <h6 class="my-0">Scientific Name: <span class="text-muted"><%= sighting.scientificName %></span></h6>
                    </div>
                    <!-- Edit button -->
                    <div class="edit-button-container">
                        <a class="text-primary edit-button">
                            <img src="/images/icons/pencil-edit.png" alt="Edit" width="18" height="18">
                        </a>
                    </div>
                </div>
            </li>

            <li class="list-group-item justify-content-between ">
                <div class="d-flex justify-content-between align-items-center">
                    <!-- Edit mode container (initially hidden) -->
                    <div class=" edit-mode d-none">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="d-flex align-items-center">
                                <!-- Label -->
                                <h6 class="my-0 me-2">Family:</h6>
                                <!-- Textarea for editing the value -->
                                <textarea class="form-control" rows="4" style="flex-grow: 1;" data-field="family"><%= sighting.family %></textarea>
                            </div>
                            <!-- Container for save and cancel buttons -->
                            <div class="">
                                <!-- Save button -->
                                <a class="text-success edit-save-btn" title="Save">
                                    <img src="/images/icons/tickmark.png" alt="Save" width="30" height="30">
                                </a>
                                <!-- Cancel button -->
                                <a class="text-danger edit-cancel-btn" title="Cancel">
                                    <img src="/images/icons/cancel.png" alt="Cancel" width="30" height="30">
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- Display mode container -->
                    <div class=" edit-mode-display">
                        <h6 class="my-0">Family: <span class="text-muted"><%= sighting.family %></span></h6>
                    </div>
                    <!-- Edit button -->
                    <div class="edit-button-container">
                        <a class="text-primary edit-button">
                            <img src="/images/icons/pencil-edit.png" alt="Edit" width="18" height="18">
                        </a>
                    </div>
                </div>
            </li>

            <li class="list-group-item justify-content-between ">
                <div class="d-flex justify-content-between align-items-center">
                    <!-- Edit mode container (initially hidden) -->
                    <div class=" edit-mode d-none">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="d-flex align-items-center">
                                <!-- Label -->
                                <h6 class="my-0 me-2">Genus:</h6>
                                <!-- Textarea for editing the value -->
                                <textarea class="form-control" rows="5" style="flex-grow: 1;" data-field="genus"><%= sighting.genus %></textarea>
                            </div>
                            <!-- Container for save and cancel buttons -->
                            <div class="">
                                <!-- Save button -->
                                <a class="text-success edit-save-btn" title="Save">
                                    <img src="/images/icons/tickmark.png" alt="Save" width="30" height="30">
                                </a>
                                <!-- Cancel button -->
                                <a class="text-danger edit-cancel-btn" title="Cancel">
                                    <img src="/images/icons/cancel.png" alt="Cancel" width="30" height="30">
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- Display mode container -->
                    <div class=" edit-mode-display">
                        <h6 class="my-0">Genus: <span class="text-muted"><%= sighting.genus %></span></h6>
                    </div>
                    <!-- Edit button -->
                    <div class="edit-button-container">
                        <a class="text-primary edit-button">
                            <img src="/images/icons/pencil-edit.png" alt="Edit" width="18" height="18">
                        </a>
                    </div>
                </div>
            </li>

            <li class="list-group-item justify-content-between">
                <div class="d-flex justify-content-between align-items-center">
                    <!-- Edit mode container (initially hidden) -->
                    <div class=" edit-mode d-none">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="d-flex align-items-center">
                                <!-- Label -->
                                <h6 class="my-0 me-2">Species:</h6>
                                <!-- Textarea for editing the value -->
                                <textarea class="form-control" rows="6" style="flex-grow: 1;" data-field="species"><%= sighting.species %></textarea>
                            </div>
                            <!-- Container for save and cancel buttons -->
                            <div class="">
                                <!-- Save button -->
                                <a class="text-success edit-save-btn" title="Save">
                                    <img src="/images/icons/tickmark.png" alt="Save" width="30" height="30">
                                </a>
                                <!-- Cancel button -->
                                <a class="text-danger edit-cancel-btn" title="Cancel">
                                    <img src="/images/icons/cancel.png" alt="Cancel" width="30" height="30">
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- Display mode container -->
                    <div class=" edit-mode-display">
                        <h6 class="my-0">Species: <span class="text-muted"><%= sighting.species %></span></h6>
                    </div>
                    <!-- Edit button -->
                    <div class="edit-button-container">
                        <a class="text-primary edit-button">
                            <img src="/images/icons/pencil-edit.png" alt="Edit" width="18" height="18">
                        </a>
                    </div>
                </div>
            </li>

            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Description : <span class="text-muted"><%= sighting.description %></span>
                    </h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Plant Size : (Length: <%= sighting.length %> x Height: <%= sighting.height %> x
                        Width: <%= sighting.width %>)</h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Characteristics:</h6><br>
                    <div class="d-flex flex-wrap gap-2">
                        <h4>
                            <span class="badge bg-primary"><%= sighting.flowering ? 'Flowering' : 'Non-Flowering' %></span>
                        </h4>
                        <h4>
                            <span class="badge bg-secondary"><%= sighting.hasLeaves ? 'Has Leaves' : 'Has No Leaves' %></span>
                        </h4>
                        <h4>
                            <span class="badge bg-success"><%= sighting.fruitBearing ? 'Fruit Bearing' : 'Non-Fruit Bearing' %></span>
                        </h4>
                        <h4><span class="badge bg-danger"><%= sighting.sunExposure %></span></h4>
                        <h4><span class="badge bg-warning text-dark">Color: <%= sighting.flowerColor %></span></h4>
                    </div>
                </div>
            </li>
        </ul>

        <h5 class="mb-3">Plant Details from DBPidiea</h5>
        <ul class="plantdetailsdbpidiea list-group mb-3">

        </ul>



        <!-- Chat button -->
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#chatModal">
            Chat about <%= sighting.name %>
        </button>
    </div>
</div>
        <!-- Chat modal -->
        <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="chatModalLabel">Chat about <%= sighting.name %></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="chatDisplayArea" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                            <!-- Messages will be displayed here -->
                        </div>
                        <br>
                        <label>Username: </label>
                        <input type="text" id="username" class="form-control" placeholder="Enter your username">
                        <br>
                        <label>Message: </label>
                        <textarea id="message" class="form-control" placeholder="Enter your message"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="sendButton">Send</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="endChatButton">End Chat</button>
                    </div>
                </div>
            </div>
        </div>

<%- include('./partials/footer'); %>

<script src="/socket.io/socket.io.js"></script>
<script src="/javascripts/idb-utility.js"></script>
<script>
    const socket = io();
    const sightingId = "<%= sighting.sightingId %>"; // Get the sighting ID
    let offlineMessages = JSON.parse(localStorage.getItem('offlineMessages')) || [];
    let lastUsername = "";

    // Join the specific sighting chat room
    socket.emit('join', { username: lastUsername || "Guest", sightingId });

    // Display chat history
    socket.on('chat history', function(messages) {
        const chatDisplayArea = document.getElementById("chatDisplayArea");
        messages.forEach((data) => {
            const { username, message, timestamp } = data;
            const bubbleType = (username === lastUsername) ? "chat-right" : "chat-left";
            displayMessage(username, message, timestamp, bubbleType);
        });
    });

    document.getElementById("sendButton").addEventListener("click", sendMessage);

    function sendMessage() {
        let username = document.getElementById("username").value;
        const message = document.getElementById("message").value;
        const now = new Date();
        const timestamp = now.toISOString();

        if (username && message) {
            lastUsername = username;  // Update last used username
            const messageData = { username, message, timestamp, sightingId };

            // If online, send the message
            if (navigator.onLine) {
                socket.emit('chat message', messageData);
            } else {
                // Store the message locally
                offlineMessages.push(messageData);
                localStorage.setItem('offlineMessages', JSON.stringify(offlineMessages));
            }

            // Clear the input fields
            document.getElementById("message").value = "";
        }
    }

    socket.on('chat message', function(data) {
        const { username, message, timestamp, sightingId: receivedSightingId } = data;
        if (receivedSightingId === sightingId) {
            const bubbleType = (username === lastUsername) ? "chat-right" : "chat-left";
            displayMessage(username, message, timestamp, bubbleType);
        }
    });

    function displayMessage(username, message, timestamp, bubbleType) {
        const chatDisplayArea = document.getElementById("chatDisplayArea");
        const formattedTime = formatTimestamp(new Date(timestamp));
        const newMessage = document.createElement("div");
        newMessage.className = `chat-bubble ${bubbleType} clearfix`;
        newMessage.innerHTML = `<strong>${username} (${formattedTime}):</strong> ${message}`;
        chatDisplayArea.appendChild(newMessage);
        chatDisplayArea.scrollTop = chatDisplayArea.scrollHeight;
    }

    function formatTimestamp(date) {
        return date.toLocaleString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
    }

    // Synchronize messages when coming back online
    window.addEventListener('online', syncOfflineMessages);

    function syncOfflineMessages() {
        offlineMessages = JSON.parse(localStorage.getItem('offlineMessages')) || [];
        offlineMessages.forEach((messageData) => {
            if (messageData.sightingId === sightingId) {
                socket.emit('chat message', messageData);
            }
        });
        offlineMessages = offlineMessages.filter(messageData => messageData.sightingId !== sightingId);
        localStorage.setItem('offlineMessages', JSON.stringify(offlineMessages));
    }

    document.querySelector(".btn-close").addEventListener("click", endChat);
    document.querySelector(".btn-secondary"). addEventListener("click", endChat);

    function endChat() {
        lastUsername = ""; // Reset the last used username when chat is ended
    }

    document.addEventListener('DOMContentLoaded', async function () {
        let plantName = '<%= sighting.name %>';
        let dbPediaPlantData;
        try {
            dbPediaPlantData = await fetchDBPediaData(plantName);
        } catch (error) {
            console.error("Error fetching data from DBpedia:", error);
        }
        let verifiedElement = document.querySelector('.verification-icon');

        // If data fetched is not empty
        if (dbPediaPlantData.results && dbPediaPlantData.results.bindings && dbPediaPlantData.results.bindings.length > 0) {
            let bindings = dbPediaPlantData.results.bindings[0];

            if (verifiedElement) {
                verifiedElement.innerHTML = '<img src="/images/blue_tick.png" alt="Verified" title="Plant is verified" class="verification-icon" style="height: 40px; width: 40px;position: relative;top: 17%;">'; // Check mark icon
            }
            let ul = document.querySelector('.plantdetailsdbpidiea');
            ul.innerHTML = '';

            let li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between lh-condensed';
            let div = document.createElement('div');
            div.innerHTML = `
                    <h6 class="my-0">Name:</h6>
                    <span class="text-muted">${bindings.label.value}</span>
                `;
            li.appendChild(div);
            ul.appendChild(li);

            li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between lh-condensed';
            div = document.createElement('div');
            div.innerHTML = `
                    <h6 class="my-0">Description:</h6>
                    <span class="text-muted">${bindings.description.value}</span>
                `;
            li.appendChild(div);
            ul.appendChild(li);

            li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between lh-condensed';
            div = document.createElement('div');
            div.innerHTML = `
                    <h6 class="my-0">DBPedia URL:</h6>
                    <a class="text-muted" href="http://dbpedia.org/resource/${encodeURIComponent(plantName)}" target="_blank">http://dbpedia.org/resource/${encodeURIComponent(plantName)}</a>
                `;
            li.appendChild(div);
            ul.appendChild(li);
        }
        //if data received from DBPedia is empty
        else {
            let ul = document.querySelector('.plantdetailsdbpidiea');
            ul.innerHTML = '';
            if (verifiedElement) {
                verifiedElement.innerHTML = '<img src="/images/red-tick.jpg" alt="Pending" title="Plant verification is in progress" class="verification-icon" style="height: 40px; width: 40px;position: relative;top: 27%;">';
            }
            let li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between lh-condensed';
            let div = document.createElement('div');
            div.innerHTML = `
                    <h6 class="my-0">Name:</h6>
                    <span class="text-muted">No data found</span>
                `;
            li.appendChild(div);
            ul.appendChild(li);

            li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between lh-condensed';
            div = document.createElement('div');
            div.innerHTML = `
                    <h6 class="my-0">Description:</h6>
                    <span class="text-muted">No description available</span>
                `;
            li.appendChild(div);
            ul.appendChild(li);

            li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between lh-condensed';
            div = document.createElement('div');
            div.innerHTML = `
                    <h6 class="my-0">DBPedia URL:</h6>
                    <a class="text-muted" href="http://dbpedia.org/resource/${encodeURIComponent(plantName)}" target="_blank">http://dbpedia.org/resource/${encodeURIComponent(plantName)}</a>
                `;
            li.appendChild(div);
            ul.appendChild(li);
        }

    });


    function initMap() {
        // Holds the value for the location
        var location = '<%= sighting.location %>';
        const [latitude, longitude] = location.split(',');

        // Convert the latitude and longitude to float values
        const lat = parseFloat(latitude.trim());
        const long = parseFloat(longitude.trim());

        createMapWithMarker(lat, long, "map");
    }

    function createMapWithMarker(latitude, longitude, mapElementId) {
        let mapOptions = {
            zoom: 5,
            center: {lat: latitude, lng: longitude}
        };
        let map = new google.maps.Map(document.getElementById(mapElementId), mapOptions);

        let markerOptions = {
            position: new google.maps.LatLng(latitude, longitude),
            map: map
        };
        let marker = new google.maps.Marker(markerOptions);
    }

    // Function to handle save button click
    function handleSaveButtonClick(event) {
        // Get the clicked element and find the parent list item
        const button = event.target.closest('.edit-save-btn');
        if (button) {
            const listItem = button.closest('.list-group-item');
            if (listItem) {
                // Retrieve the textarea and its data-field attribute
                const textarea = listItem.querySelector('textarea');
                const fieldName = textarea.getAttribute('data-field');

                // Get the value from the textarea
                const newValue = textarea.value;

                // Handle saving the value for the specific field
                // For example, you can send this information to your server or update your state
                console.log(`Field: ${fieldName}, New Value: ${newValue}`);

                // Update the display mode text with the new value from the textarea
                listItem.querySelector('.edit-mode-display span').textContent = newValue;

                // Switch back to display mode
                listItem.querySelector('.edit-mode').classList.add('d-none');
                listItem.querySelector('.edit-mode-display').classList.remove('d-none');

                const formData = {
                    sightingId:'<%= sighting.sightingId%>',
                    username: '<%= sighting.username%>',
                    email: '<%= sighting.email%>',
                    phoneNumber: '<%= sighting.phoneNumber%>',
                    name: '<%= sighting.name%>',
                    commonName: '<%= sighting.commonName%>',
                    scientificName: '<%= sighting.scientificName%>',
                    family: '<%= sighting.family%>',
                    genus: '<%= sighting.genus%>',
                    species: '<%= sighting.species%>',
                    description: '<%= sighting.description%>',
                    length: '<%= sighting.length%>',
                    width: '<%= sighting.width%>',
                    height: '<%= sighting.height%>',
                    hasLeaves: '<%= sighting.hasLeaves%>',
                    flowering: '<%= sighting.flowering%>',
                    fruitBearing: '<%= sighting.fruitBearing%>',
                    sunExposure: '<%= sighting.sunExposure%>',
                    flowerColor: '<%= sighting.flowerColor%>',
                    identificationLink: '<%= sighting.identificationLink%>',

                    date: '<%= sighting.date%>',
                    status: '<%= sighting.status%>',
                    altitude: '<%= sighting.altitude%>',
                    location: '<%= sighting.location%>',
                    line: '<%= sighting.line%>',
                    city: '<%= sighting.city%>',
                    state: '<%= sighting.state%>',
                    country: '<%= sighting.country%>',
                    pinCode: '<%= sighting.pinCode%>',
                    userid: '<%= sighting.userid%>',
                    uploadImage: '<%= sighting.uploadImage%>'
                };

                console.log("Field Name", fieldName);
                console.log("Before adding field name", formData);
                switch (fieldName) {
                    case "name":
                        formData.name = newValue;
                        console.log("Inside Name");
                        break
                    case "common-name":
                        console.log("Inside Common Name");
                        formData.commonName = newValue;
                        break
                    case "scientific-name":
                        console.log("Inside Scientific Name");
                        formData.scientificName = newValue;
                        break
                    case "family":
                        console.log("Inside Family");
                        formData.family = newValue;
                        break
                    case "genus":
                        console.log("Inside Genus");
                        formData.genus = newValue;
                        break
                    case "species":
                        console.log("Inside Species");
                        formData.species = newValue;
                        break
                }
                console.log("After adding field name", formData);

                    addNewPlantsToSyncIDBInBothModes(formData);
            }
        }
    }

    // Attach event listeners to all edit, save, and cancel buttons
    document.addEventListener('click', function(event) {
        // Handle edit button click
        if (event.target.closest('.edit-button')) {
            const editButton = event.target.closest('.edit-button');
            const listItem = editButton.closest('.list-group-item');

            // Hide the edit button
            editButton.style.display = 'none';

            // Show the edit mode (includes the textarea, save, and cancel buttons)
            listItem.querySelector('.edit-mode').classList.remove('d-none');
            listItem.querySelector('.edit-mode-display').classList.add('d-none');

            // Optionally, focus the textarea for immediate editing
            const textarea = listItem.querySelector('.edit-mode textarea');
            if (textarea) {
                textarea.focus();
            }
        }

        // Handle save button click
        if (event.target.closest('.edit-save-btn')) {
            const saveButton = event.target.closest('.edit-save-btn');
            const listItem = saveButton.closest('.list-group-item');

            // Save the updated value from the textarea
            const textarea = listItem.querySelector('textarea');
            const newName = textarea.value;

            // Update the displayed name
            const nameSpan = listItem.querySelector('.edit-mode-display span');
            nameSpan.textContent = newName;
            handleSaveButtonClick(event);

            // Switch back to display mode
            listItem.querySelector('.edit-mode').classList.add('d-none');
            listItem.querySelector('.edit-mode-display').classList.remove('d-none');

            // Show the edit button again
            listItem.querySelector('.edit-button').style.display = 'inline-block';
        }

        // Handle cancel button click
        if (event.target.closest('.edit-cancel-btn')) {
            const cancelButton = event.target.closest('.edit-cancel-btn');
            const listItem = cancelButton.closest('.list-group-item');

            // Revert the textarea to the original value
            const textarea = listItem.querySelector('textarea');
            const originalName = listItem.querySelector('.edit-mode-display span').textContent;
            textarea.value = originalName;

            // Switch back to display mode
            listItem.querySelector('.edit-mode').classList.add('d-none');
            listItem.querySelector('.edit-mode-display').classList.remove('d-none');

            // Show the edit button again
            listItem.querySelector('.edit-button').style.display = 'inline-block';
        }
    });

</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
</body>
</html>
