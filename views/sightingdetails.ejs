<!DOCTYPE html>
<html lang="en">

<!-- Head Section -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Details</title>
    <link rel="stylesheet" href="./stylesheets/plantdetails/style.css">
    <script src='/javascripts/API.js'></script>
    <script>
        API();
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <%- include('./partials/base'); %>
</head>

<!-- Body Section -->
<body>

<!-- Header Section -->
<%- include('./partials/header', { title: 'Plant Details',visibility:'hidden' }); %>
<br> <br> <br>
<div class="row">
    <div class="col-md-4 order-md-2 mb-4">

        <!-- User Details Sections -->
        <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">User Details</span>
            <span class="badge badge-secondary badge-pill">3</span>
        </h4>
        <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between bg-light">
                <div class="text-success">
                    <h6 class="my-0">Username :</h6>
                </div>
                <span class="text-success"><%= sighting.username %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Email ID</h6>
                </div>
                <span class="text-muted"> <%= sighting.email %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Contact Number</h6>
                </div>
                <span class="text-muted"><%= sighting.phoneNumber %></span>
            </li>
        </ul>

        <!-- Sighting Details Section -->
        <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Sighting Details</span>
            <span class="badge badge-secondary badge-pill">3</span>
        </h4>
        <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div id="map" style="height: 300px; width: 600px;">

                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Elevation</h6>
                </div>
                <span class="text-muted"><%= sighting.altitude %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Address</h6>
                </div>
                <span class="text-muted"> <%= sighting.line %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">City/Town</h6>
                </div>
                <span class="text-muted"><%= sighting.city %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">State</h6>
                </div>
                <span class="text-muted"> <%= sighting.state %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Postal Code</h6>
                </div>
                <span class="text-muted"><%= sighting.pinCode %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Country</h6>
                </div>
                <span class="text-muted"> <%= sighting.country %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Date of Sighting</h6>
                </div>
                <span class="text-muted"> <%= sighting.date %></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Number of Observations</h6>
                </div>
                <span class="text-muted"><%=          %></span>
            </li>
        </ul>
    </div>
    <div class="col-md-8 order-md-1">
        <h4 class="mb-3">Plant Details</h4>
        <hr>
        <h1 style="font-size:xxx-large; color: #36454F"><%= sighting.name %></h1>
        <h5 class="link-dark" style="font-size: small">
            Reference link: <a href="<%= sighting.identificationLink %>"
                               class="text-primary"><%= sighting.identificationLink %></a>
        </h5>
        <br>
        <div class="image-container">
                <img src="<%=sighting.uploadImage%>" alt="Plant Image"
                     style="max-height: 200px;max-width: 200px;" loading="lazy">
        </div>
        <br><br>
        <ul class="list-group mb-3">
            <li class="list-group-item justify-content-between bg-light">
                <div class="text-success">
                    <h6 class="my-0">Plant Name : <span class="text-success"><%= sighting.name %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Common Name : <span class="text-muted"><%= sighting.commonName %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Scientific Name : <span
                                class="text-muted"><%= sighting.scientificName %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Family : <span class="text-muted"><%= sighting.family %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Genus : <span class="text-muted"><%= sighting.genus %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Species : <span class="text-muted"><%= sighting.species %></span></h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Description : <span class="text-muted"><%= sighting.description %></span>
                    </h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Plant Size : (Length: <%= sighting.length %> x Height: <%= sighting.height %> x Width: <%= sighting.width %>)</h6>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                    <h6 class="my-0">Characteristics:</h6><br>
                    <div class="d-flex flex-wrap gap-2">
                        <h4><span class="badge bg-primary"><%= sighting.flowering ? 'Flowering' : 'Non-Flowering' %></span></h4>
                        <h4><span class="badge bg-secondary"><%= sighting.hasLeaves ? 'Has Leaves' : 'Has No Leaves' %></span></h4>
                        <h4><span class="badge bg-success"><%= sighting.fruitBearing ? 'Fruit Bearing' : 'Non-Fruit Bearing' %></span></h4>
                        <h4><span class="badge bg-danger"><%= sighting.sunExposure %></span></h4>
                        <h4><span class="badge bg-warning text-dark">Color: <%= sighting.flowerColor %></span></h4>
                    </div>
                </div>
            </li>
        </ul>
        <!-- Chat button -->
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#chatModal">
            Chat about <%= sighting.name %>
        </button>

        <!-- Chat modal -->
        <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="chatModalLabel">Chat about <%= sighting.name %></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="chatDisplayArea" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                            <!-- Messages will be displayed here -->
                        </div>
                        <br>
                        <label>Username: </label>
                        <input type="text" id="username" class="form-control" placeholder="Enter your username">
                        <br>
                        <label>Message: </label>
                        <textarea id="message" class="form-control" placeholder="Enter your message"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="sendButton">Send</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="endChatButton">End Chat</button>
                    </div>
                </div>
            </div>
        </div>
        <script src="/socket.io/socket.io.js"></script>

        <script>
            const socket = io();
            const sightingId = "<%= sighting.sightingId %>"; // Get the sighting ID
            let offlineMessages = JSON.parse(localStorage.getItem('offlineMessages')) || [];
            let lastUsername = "";

            // Join the specific sighting chat room
            socket.emit('join', { username: lastUsername || "Guest", sightingId });

            // Display chat history
            socket.on('chat history', function(messages) {
                const chatDisplayArea = document.getElementById("chatDisplayArea");
                messages.forEach((data) => {
                    const { username, message, timestamp } = data;
                    const bubbleType = (username === lastUsername) ? "chat-right" : "chat-left";
                    displayMessage(username, message, timestamp, bubbleType);
                });
            });

            document.getElementById("sendButton").addEventListener("click", sendMessage);

            function sendMessage() {
                let username = document.getElementById("username").value;
                const message = document.getElementById("message").value;
                const now = new Date();
                const timestamp = now.toISOString();

                if (username && message) {
                    lastUsername = username;  // Update last used username
                    const messageData = { username, message, timestamp, sightingId };

                    // If online, send the message
                    if (navigator.onLine) {
                        socket.emit('chat message', messageData);
                    } else {
                        // Store the message locally
                        offlineMessages.push(messageData);
                        localStorage.setItem('offlineMessages', JSON.stringify(offlineMessages));
                    }

                    // Clear the input fields
                    document.getElementById("message").value = "";
                }
            }

            socket.on('chat message', function(data) {
                const { username, message, timestamp, sightingId: receivedSightingId } = data;
                if (receivedSightingId === sightingId) {
                    const bubbleType = (username === lastUsername) ? "chat-right" : "chat-left";
                    displayMessage(username, message, timestamp, bubbleType);
                }
            });

            function displayMessage(username, message, timestamp, bubbleType) {
                const chatDisplayArea = document.getElementById("chatDisplayArea");
                const formattedTime = formatTimestamp(new Date(timestamp));
                const newMessage = document.createElement("div");
                newMessage.className = `chat-bubble ${bubbleType} clearfix`;
                newMessage.innerHTML = `<strong>${username} (${formattedTime}):</strong> ${message}`;
                chatDisplayArea.appendChild(newMessage);
                chatDisplayArea.scrollTop = chatDisplayArea.scrollHeight;
            }

            function formatTimestamp(date) {
                return date.toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
            }

            // Synchronize messages when coming back online
            window.addEventListener('online', syncOfflineMessages);

            function syncOfflineMessages() {
                offlineMessages = JSON.parse(localStorage.getItem('offlineMessages')) || [];
                offlineMessages.forEach((messageData) => {
                    if (messageData.sightingId === sightingId) {
                        socket.emit('chat message', messageData);
                    }
                });
                offlineMessages = offlineMessages.filter(messageData => messageData.sightingId !== sightingId);
                localStorage.setItem('offlineMessages', JSON.stringify(offlineMessages));
            }

            document.querySelector(".btn-close").addEventListener("click", endChat);
            document.querySelector(".btn-secondary"). addEventListener("click", endChat);

            function endChat() {
                lastUsername = ""; // Reset the last used username when chat is ended
            }
        </script>






    </div>
</div>
<%- include('./partials/footer'); %>


<script>
    function initMap() {

        // Holds the value for the location
        var location = '<%= sighting.location %>';
        const [latitude, longitude] = location.split(',');

        // Convert the latitude and longitude to float values
        const lat = parseFloat(latitude.trim());
        const long = parseFloat(longitude.trim());

        createMapWithMarker(lat, long, "map");
    }

    function createMapWithMarker(latitude, longitude, mapElementId) {
        let mapOptions = {
            zoom: 5,
            center: {lat: latitude, lng: longitude}
        };
        let map = new google.maps.Map(document.getElementById(mapElementId), mapOptions);

        let markerOptions = {
            position: new google.maps.LatLng(latitude, longitude),
            map: map
        };
        let marker = new google.maps.Marker(markerOptions);
    }
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
</body>
</html>
